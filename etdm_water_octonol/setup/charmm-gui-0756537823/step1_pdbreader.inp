* GENERATED BY CHARMM-GUI (http://www.charmm-gui.org) v3.1 on Dec, 09. 2020. JOBID=0756537823
* READ PDB, MANIPULATE STRUCTURE IF NEEDED, AND GENERATE TOPOLOGY FILE
*

DIMENS CHSIZE 5000000 MAXRES 3000000

! Read topology and parameter files
stream toppar.str

open read card unit 10 name input_heta.crd
read sequence coor card unit 10 resid
generate HETA setup warn first none last none

open read unit 10 card name input_heta.crd
read coor unit 10 card resid

open read card unit 10 name input_hetb.crd
read sequence coor card unit 10 resid
generate HETB setup warn first none last none

open read unit 10 card name input_hetb.crd
read coor unit 10 card resid

open read card unit 10 name input_hetc.crd
read sequence coor card unit 10 resid
generate HETC setup warn first none last none

open read unit 10 card name input_hetc.crd
read coor unit 10 card resid

open read card unit 10 name input_hetd.crd
read sequence coor card unit 10 resid
generate HETD setup warn first none last none

open read unit 10 card name input_hetd.crd
read coor unit 10 card resid

bomlev -1 ! to ignore for three membered ring warning
open read card unit 10 name input_hete.crd
read sequence coor card unit 10 resid
generate HETE setup warn first none last none

open read unit 10 card name input_hete.crd
read coor unit 10 card resid
bomlev  0
!Print heavy atoms with unknown coordinates
coor print sele ( .not. INIT ) .and. ( .not. hydrogen ) end

define ROT sele .byres. (.not. INIT .and. (type CB .or. type CG*)) .and. .not. resn *PRO end
define XXX sele ROT .and. type CA end
set nres = ?nsel
set ires = 1
label build_rot
    define YYY sele .byres. ( XXX .subset. @ires ) end
    define ZZZ sele .bonded. YYY .and. .not. YYY .and. .not. (type N .or. type C) end
    if ?nsel .gt. 0 define ROT sele ROT .and. .not. YYY end
    incr ires by 1
if ires .le. @nres goto build_rot

ic param
ic build
define LONEPAIR sele chem LPH end
if ?nsel .gt. 0 coor shake sele LONEPAIR end
prnlev 0
hbuild sele hydr end 
prnlev 5

! check if there are unknown coordinate
define XXX sele .not. INIT show end
if ?nsel .gt. 0 stop ! ABNORMAL TERMINATION: Undefined coordinates

ENERGY

define XXX sele ROT .and. type CB end
if ?nsel .gt. 0 then
   cons fix sele .not. ROT end
   MOVE ADD MVTP TORS DMAX 360.0 sele ROT .and. type CA end -
                                 sele ROT .and. type CB end
   MC NSTEP 5000
   MOVE DELETE MVIN 1
   cons fix sele none end
endif


open write unit 10 card name step1_pdbreader.psf
write psf  unit 10 card

open write card unit 10 name step1_pdbreader.crd
write coor unit 10 card

open write card unit 10 name step1_pdbreader.pdb
write coor pdb  unit 10 official

coor stat sele all end

calc cgtot = int ( ?cgtot )

open write unit 90 card name step1_pdbreader.str
write title unit 90
* set ncharge = @cgtot
* set xmax = ?xmax
* set ymax = ?ymax
* set zmax = ?zmax
* set xmin = ?xmin
* set ymin = ?ymin
* set zmin = ?zmin
*

stop

